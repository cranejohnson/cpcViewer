<!doctype html>
<html lang="en">
	<head>
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
		<script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
		<script src="//cdn.jsdelivr.net/leaflet.esri/2.0.0-beta.7/esri-leaflet.js"></script>
		<script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
		<script src = "http://momentjs.com/downloads/moment.min.js"></script>
		<script src="/js/L.Map.Sync.js"></script>
		<script src="/js/leaflet-clonelayer.js"></script>
		<script src="/js/togeojson.js"></script>
		<style>
			.map {
				height: 300px;
				width: 400px;
				float:left;
				padding-left:5px;
				padding-right:5px;
		
			  }
			.subtitle{
				font-size: 14px;
				height:20px;
				}
		
			#currentDate {
				text-align: center;
				height:20px;
				}
		
			.cpc {
				  text-align: center;
				  font-size: 24px;
				  float:left;
				  width:820px;
				  font-family: sans-serif;
				  background-color: gainsboro;
				  margin-top:10px;
		
				}
			.msg{
				 text-align: center;
				 font-family: sans-serif;
				 width:100%;
				 height:20px;
				 float:left;
				 position: relative;
				 top: 50%;
				 transform: translateY(10%);
				}
			 #main {
				width:820px;
				font-family: sans-serif;
			 }
			 .col {
				width:407px;
				float:left;
				border-style: solid;
				border-width: 1px;
			 }
			 .button {
				width:50%;
				float:left;
		
			 }
			 img {
				width:100%;
			 }
			 #legend {
			  width:100%;
			  font-size: 12px;
			  font-weight: bold;
			  text-align: center;
			  }
			.label{
				font-size: 12px;
				white-space:nowrap;
				font-weight: bold;
				text-shadow: 0 0 0.1em white, 0 0 0.1em white,
					0 0 0.1em white,0 0 0.1em white,0 0 0.1em;
				color: #000;
				background: none;
				border: none;
				box-shadow: none;
			}
		</style>
	</head>
	<body>
		<div id="main">

        Current Date:<input type="text" name="firstname" id='currentDate1'><button  class = ' back'>-1 Day</button><button  class = ' forward'>+1 Day</button>
        <button  class = ' backYear'>-1 Year</button><button  class = ' forwardYear'>+1 Year</button><br>
        <button id='larger' type="button" >Larger</button>
        <button id='smaller' type="button" >Smaller</button>
		<label><input type="checkbox" id="cityToggle" checked>View Cities</label></br>


        <table>
        <tr><td>
        <div class = 'cpc'>6-10 Day CPC Outlook<div id='title610' class='subtitle'></div></div>
        <div class = 'col'>
            <div id="message" class='msg'>Temperature</div>
            <div id="map" class="map"></div>
            <table id='legend'>
                <tr height="20"><td bgcolor="#150C32"></td><td bgcolor="#190F40"></td><td bgcolor="#222D5B"></td><td bgcolor="#094891"></td><td bgcolor="#2E8CD2"></td><td bgcolor="#66A5DB"></td><td bgcolor="#90B2D7"></td><td bgcolor="#FEFEFE"></td><td bgcolor="#E0A256"></td><td bgcolor="#E0A256"></td><td bgcolor="#CF4025"></td><td bgcolor="#B81A1F"></td><td bgcolor="#BE1A37"></td><td bgcolor="#75202B"></td><td bgcolor="#4E171E"></td></tr>
                <tr><td>90</td><td>80</td><td>70</td><td>60</td><td>50</td><td>40</td><td>33</td><td>Normal</td><td>33</td><td>40</td><td>50</td><td>60</td><td>70</td><td>80</td><td>90</td></tr>
                <tr><td colspan='7'>Prob. of Significantly Below (%)</td><td></td><td colspan='7'>Prob. of Significantly Above (%)</td></tr>
            </table>
        </div>
        <div class = 'col'>
            <div id="message2" class='msg'>Precipitation</div>
            <div id="map2" class="map"></div>
            <table id='legend'>
                <tr height="20"><td bgcolor="#3C2223"></td><td bgcolor="#6C3002"></td><td bgcolor="#7F322A"></td><td bgcolor="#873D25"></td><td bgcolor="#AA5826"></td><td bgcolor="#CE973E"></td><td bgcolor="#ECCC81"></td><td bgcolor="#FEFEFE"></td><td bgcolor="#A5D39B"></td><td bgcolor="#84C56B"></td><td bgcolor="#3CA22B"></td><td bgcolor="#2D6A4B"></td><td bgcolor="#117F31"></td><td bgcolor="#1F442E"></td><td bgcolor="#1F4512"></td></tr>
                <tr><td>90</td><td>80</td><td>70</td><td>60</td><td>50</td><td>40</td><td>33</td><td>Normal</td><td>33</td><td>40</td><td>50</td><td>60</td><td>70</td><td>80</td><td>90</td></tr>
                <tr><td colspan='7'>Prob. of Significantly Below (%)</td><td></td><td colspan='7'>Prob. of Significantly Above (%)</td></tr>
            </table>

        </div>
        <div class = 'cpc'>8-14 Day CPC Outlook<div id='title814' class='subtitle'></div></div>
        <div class = 'col'>
            <div id="message3" class='msg'>Temperature</div>
            <div id="map3" class="map"></div>
            <table id='legend'>
                <tr height="20"><td bgcolor="#150C32"></td><td bgcolor="#190F40"></td><td bgcolor="#222D5B"></td><td bgcolor="#094891"></td><td bgcolor="#2E8CD2"></td><td bgcolor="#66A5DB"></td><td bgcolor="#90B2D7"></td><td bgcolor="#FEFEFE"></td><td bgcolor="#E0A256"></td><td bgcolor="#E0A256"></td><td bgcolor="#CF4025"></td><td bgcolor="#B81A1F"></td><td bgcolor="#BE1A37"></td><td bgcolor="#75202B"></td><td bgcolor="#4E171E"></td></tr>
                <tr><td>90</td><td>80</td><td>70</td><td>60</td><td>50</td><td>40</td><td>33</td><td>Normal</td><td>33</td><td>40</td><td>50</td><td>60</td><td>70</td><td>80</td><td>90</td></tr>
                <tr><td colspan='7'>Prob. of Significantly Below (%)</td><td></td><td colspan='7'>Prob. of Significantly Above (%)</td></tr>
            </table>
        </div>
        <div class = 'col'>
            <div id="message4" class='msg'>Precipitation</div>
            <div id="map4" class="map"></div>
            <table id='legend'>
                <tr height="20"><td bgcolor="#3C2223"></td><td bgcolor="#6C3002"></td><td bgcolor="#7F322A"></td><td bgcolor="#873D25"></td><td bgcolor="#AA5826"></td><td bgcolor="#CE973E"></td><td bgcolor="#ECCC81"></td><td bgcolor="#FEFEFE"></td><td bgcolor="#A5D39B"></td><td bgcolor="#84C56B"></td><td bgcolor="#3CA22B"></td><td bgcolor="#2D6A4B"></td><td bgcolor="#117F31"></td><td bgcolor="#1F442E"></td><td bgcolor="#1F4512"></td></tr>
                <tr><td>90</td><td>80</td><td>70</td><td>60</td><td>50</td><td>40</td><td>33</td><td>Normal</td><td>33</td><td>40</td><td>50</td><td>60</td><td>70</td><td>80</td><td>90</td></tr>
                <tr><td colspan='7'>Prob. of Significantly Below (%)</td><td></td><td colspan='7'>Prob. of Significantly Above (%)</td></tr>
            </table>

        </div>
        </td><td>
        <div class = 'cpc'>Monthly CPC Outlook<div id='titleMonthly' class='subtitle'></div></div>
        <div class = 'col'>
            <div id="message5" class='msg'>Temperature</div>
            <div id="map5" class="map"></div>
            <table id='legend'>
                <tr height="20"><td bgcolor="#150C32"></td><td bgcolor="#190F40"></td><td bgcolor="#222D5B"></td><td bgcolor="#094891"></td><td bgcolor="#2E8CD2"></td><td bgcolor="#66A5DB"></td><td bgcolor="#90B2D7"></td><td bgcolor="#FEFEFE"></td><td bgcolor="#E0A256"></td><td bgcolor="#E0A256"></td><td bgcolor="#CF4025"></td><td bgcolor="#B81A1F"></td><td bgcolor="#BE1A37"></td><td bgcolor="#75202B"></td><td bgcolor="#4E171E"></td></tr>
                <tr><td>90</td><td>80</td><td>70</td><td>60</td><td>50</td><td>40</td><td>33</td><td>Normal</td><td>33</td><td>40</td><td>50</td><td>60</td><td>70</td><td>80</td><td>90</td></tr>
                <tr><td colspan='7'>Prob. of Significantly Below (%)</td><td></td><td colspan='7'>Prob. of Significantly Above (%)</td></tr>
            </table>
        </div>
        <div class = 'col'>
            <div id="message6" class='msg'>Precipitation</div>
            <div id="map6" class="map"></div>
            <table id='legend'>
                <tr height="20"><td bgcolor="#3C2223"></td><td bgcolor="#6C3002"></td><td bgcolor="#7F322A"></td><td bgcolor="#873D25"></td><td bgcolor="#AA5826"></td><td bgcolor="#CE973E"></td><td bgcolor="#ECCC81"></td><td bgcolor="#FEFEFE"></td><td bgcolor="#A5D39B"></td><td bgcolor="#84C56B"></td><td bgcolor="#3CA22B"></td><td bgcolor="#2D6A4B"></td><td bgcolor="#117F31"></td><td bgcolor="#1F442E"></td><td bgcolor="#1F4512"></td></tr>
                <tr><td>90</td><td>80</td><td>70</td><td>60</td><td>50</td><td>40</td><td>33</td><td>Normal</td><td>33</td><td>40</td><td>50</td><td>60</td><td>70</td><td>80</td><td>90</td></tr>
                <tr><td colspan='7'>Prob. of Significantly Below (%)</td><td></td><td colspan='7'>Prob. of Significantly Above (%)</td></tr>
            </table>

        </div>
        </td></tr></table>

    </div>
	</body>
	<script>
		function getURLParameter(name) {
            return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search)||[,""])[1].replace(/\+/g, '%20'))||null
        }
		
		var monthlyDate;
        var currentDate;
        var yesterday ;
        var tomorrow ;
        var searchDir = -1;   //Search backwards if data is missing
        if(getURLParameter('dir') == 'forward'){
            searchDir = 1;
        }

        var newW = 300;

        if(getURLParameter('width')){
            newW = parseInt(getURLParameter('width'));
        }
        $('.map').width(newW);
        $('#main').width(newW*2+30);
        $('.col').width(newW+12);
        $('.cpc').width(newW*2+30);
        $('.map').height(newW*0.75);

        if(getURLParameter('date')){
            $('#currentDate1').val(moment(getURLParameter('date')).format('YYYY-MM-DD'));
        }

        if(moment() < moment($('#currentDate1').val())){
            $('#currentDate1').val(moment().format('YYYY-MM-DD'));
        }

        if($('#currentDate1').val()){
            currentDate = moment($('#currentDate1').val()+" 12:00","YYYY-MM-DD");
            yesterday = moment($('#currentDate1').val()+" 12:00","YYYY-MM-DD").add(-1,'days');
            tomorrow = moment($('#currentDate1').val()+" 12:00","YYYY-MM-DD").add(1,'days');
            plotDate = getURLParameter('date').split("-").join("");
            monthlyDate = moment(getURLParameter('date')+" 12:00","YYYY-MM-DD");

        }
        else{
            currentDate = moment.utc();
            yesterday = moment.utc().add(-1,'days');
            tomorrow = moment.utc().add(1,'days');
            plotDate = moment.utc().format('YYYYMMDD');
            monthlyDate = moment.utc();

        }
		
		var found610 = false;
        var foundMonthly = false;
        var y = 0;
        var i = 0;
		var citiesLayer,citiesLayer2,citiesLayer3,citiesLayer4,citiesLayer5,citiesLayer6;

        while(i < 30){
            $.ajax({
                type: "GET",
                url: 'cpcData/610temp_'+currentDate.format('YYYYMMDD')+'.kml',
                dataType: "xml",
                async: false,
                success: function(xml){
                    var temp = $(xml).find('name').first().text();
                    $("#title610").html(currentDate.format('YYYY-MM-DD'));
                    $("#title610").html(temp.match(/(Created.*)/)[0]);
                    found610 = true;
                },
                error: function(){
                        currentDate.add(searchDir,'days');
                        yesterday.add(searchDir,'days');
                        tomorrow.add(searchDir,'days');
                }
            });
            i = i+1;
            if(found610 === true) break;
        }


       $.ajax({
            type: "GET",
            url: 'cpcData/814temp_'+currentDate.format('YYYYMMDD')+'.kml',
            dataType: "xml",
            async: false,
            success: function(xml){
                var temp = $(xml).find('name').first().text();
                $("#title814").html(currentDate.format('YYYY-MM-DD'));
                $("#title814").html(temp.match(/(Created.*)/)[0]);
            }
        });



        while(y < 30){
             $.ajax({
                type: "GET",
                url: 'cpcData/monthly_temp_'+monthlyDate.format('YYYYMMDD')+'.kml',
                dataType: "xml",
                async: false,
                success: function(xml){
                    var temp = $(xml).find('name').first().text();
                    $("#titleMonthly").html(currentDate.format('YYYY-MM-DD'));
                    $("#titleMonthly").html(temp.match(/(Created.*)/)[0]);
                    foundMonthly = true;
                },
                error: function(){
                    monthlyDate.add(-1,'days');
                }
            });
            if(foundMonthly) break;
            y = y+1;
       }

        $("#currentDate1").val(currentDate.format('YYYY-MM-DD'));
		
		//create maps
		var map = L.map("map", { zoomControl:false }).setView([64.232106, -152.172802], 3);
		L.esri.basemapLayer("Topographic").addTo(map);
		
		var map2 = L.map("map2", { zoomControl:false }).setView([64.232106, -152.172802], 3);
		L.esri.basemapLayer("Topographic").addTo(map2);
		
		var map3 = L.map("map3", { zoomControl:false }).setView([64.232106, -152.172802], 3);
		L.esri.basemapLayer("Topographic").addTo(map3);
		
		var map4 = L.map("map4", { zoomControl:false }).setView([64.232106, -152.172802], 3);
		L.esri.basemapLayer("Topographic").addTo(map4);
		
		var map5 = L.map("map5", { zoomControl:false }).setView([64.232106, -152.172802], 3);
		L.esri.basemapLayer("Topographic").addTo(map5);
		
		var map6 = L.map("map6", { zoomControl:false }).setView([64.232106, -152.172802], 3);
		L.esri.basemapLayer("Topographic").addTo(map6);
		
		function polystyle(feature) {
			fillColor = feature.properties.fill;
			lineColor = feature.properties.stroke;
			return {
				fillColor: fillColor,
				weight: 1,
				opacity: 0.8,
				color: lineColor, 
				fillOpacity: 0.8
			};
		}
		
		function highlightFeature(e) {
			var layer = e.target;
			//console.log(layer);
			var mapId = layer._map._container.attributes.id.nodeValue;
			var message = layer.feature.properties.name;
			$( "#"+mapId ).siblings( ".msg" ).text(message);
			$( "#"+mapId ).siblings( ".msg" ).css( "font-size", "10px" );
			layer.setStyle({
				weight: 5,
				color: 'blue',
				opacity: 0.5,
				fillOpacity: 0.1,
			});
		
			if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
				layer.bringToFront();
			}
		}
		
		//create geojson layers from kml data and add to appropriate map
		$.ajax('cpcData/610temp_'+currentDate.format('YYYYMMDD')+'.kml').done(function(xml) {
			temp610Geojson = toGeoJSON.kml(xml);
			console.log(temp610Geojson);
			temp610 = L.geoJson(temp610Geojson, {
				style: polystyle,
				onEachFeature: function (feature, layer) {
					layer.on('mouseover', highlightFeature);
					layer.on('mouseout', function () {
						temp610.resetStyle(this);
						$("#message").text("Temperature").css( "font-size", "14px" );
						citiesLayer.bringToFront();
					});
				}
			}).addTo(map);
		});
		
		$.ajax('cpcData/610prcp_'+currentDate.format('YYYYMMDD')+'.kml').done(function(xml) {
			precip610Geojson = toGeoJSON.kml(xml);
			console.log(precip610Geojson);
			precip610 = L.geoJson(precip610Geojson, {
				style: polystyle,
				onEachFeature: function (feature, layer) {
					layer.on('mouseover', highlightFeature);
					layer.on('mouseout', function () {
						precip610.resetStyle(this);
						$("#message2").text("Precipitation").css( "font-size", "14px" );
						citiesLayer2.bringToFront();
					});
				}
			}).addTo(map2);
		});
		
		$.ajax('cpcData/814temp_'+currentDate.format('YYYYMMDD')+'.kml').done(function(xml) {
			temp814Geojson = toGeoJSON.kml(xml);
			console.log(temp814Geojson);
			temp814 = L.geoJson(temp814Geojson, {
				style: polystyle,
				onEachFeature: function (feature, layer) {
					layer.on('mouseover', highlightFeature);
					layer.on('mouseout', function () {
						temp814.resetStyle(this);
						$("#message3").text("Temperature").css( "font-size", "14px" );
						citiesLayer3.bringToFront();
					});
				}
			}).addTo(map3);
		});
		
		$.ajax('cpcData/814prcp_'+currentDate.format('YYYYMMDD')+'.kml').done(function(xml) {
			precip814Geojson = toGeoJSON.kml(xml);
			console.log(precip814Geojson);
			precip814 = L.geoJson(precip814Geojson, {
				style: polystyle,
				onEachFeature: function (feature, layer) {
					layer.on('mouseover', highlightFeature);
					layer.on('mouseout', function () {
						precip814.resetStyle(this);
						$("#message4").text("Precipitation").css( "font-size", "14px" );
						citiesLayer4.bringToFront();
					});
				}
			}).addTo(map4);
		});
		
		$.ajax('cpcData/monthly_temp_'+monthlyDate.format('YYYYMMDD')+'.kml').done(function(xml) {
			tempMonthlyGeojson = toGeoJSON.kml(xml);
			console.log(tempMonthlyGeojson);
			tempMonthly = L.geoJson(tempMonthlyGeojson, {
				style: polystyle,
				onEachFeature: function (feature, layer) {
					layer.on('mouseover', highlightFeature);
					layer.on('mouseout', function () {
						tempMonthly.resetStyle(this);
						$("#message5").text("Temperature").css( "font-size", "14px" );
						citiesLayer5.bringToFront();
					});
				}
			}).addTo(map5);
		});
		
		$.ajax('cpcData/monthly_prcp_'+monthlyDate.format('YYYYMMDD')+'.kml').done(function(xml) {
			precipMonthlyGeojson = toGeoJSON.kml(xml);
			console.log(precipMonthlyGeojson);
			precipMonthly = L.geoJson(precipMonthlyGeojson, {
				style: polystyle,
				onEachFeature: function (feature, layer) {
					layer.on('mouseover', highlightFeature);
					layer.on('mouseout', function () {
						precipMonthly.resetStyle(this);
						$("#message6").text("Precipitation").css( "font-size", "14px" );
						citiesLayer6.bringToFront();
					});
				}
			}).addTo(map6);
		});
		
		//City Marker Properties
		var geojsonMarkerOptions = {
			radius: 3,
			fillColor: "black",
			color: "black",
			weight: 1,
			opacity: 1,
			fillOpacity: 0.8
		};
		$.ajax({
			type: "POST",
			url: "cities.json",
			dataType: 'json',
			success: function (response) {
				//console.log(response);
				citiesLayer = L.geoJson(response, {
					pointToLayer: function (feature, latlng) {
						var name = feature.properties.name;
						return L.circleMarker(latlng, geojsonMarkerOptions).bindTooltip(name,{permanent: true, direction: 'center', offset: L.point({x: 0, y: 10}), className: 'label'});
					}
				});
				map.addLayer(citiesLayer);
				//clone cityName layer
				citiesLayer2 = cloneLayer(citiesLayer);
				citiesLayer3 = cloneLayer(citiesLayer);
				citiesLayer4 = cloneLayer(citiesLayer);
				citiesLayer5 = cloneLayer(citiesLayer);
				citiesLayer6 = cloneLayer(citiesLayer);
				map2.addLayer(citiesLayer2);
				map3.addLayer(citiesLayer3);
				map4.addLayer(citiesLayer4);
				map5.addLayer(citiesLayer5);
				map6.addLayer(citiesLayer6);
				citiesLayer.bringToFront();
			}
		});
		
		//sync
		map.sync(map2);map.sync(map3);map.sync(map4);map.sync(map5);map.sync(map6);
		map2.sync(map);map2.sync(map3);map2.sync(map4);map2.sync(map5);map2.sync(map6);
		map3.sync(map2);map3.sync(map);map3.sync(map4);map3.sync(map5);map3.sync(map6);
		map4.sync(map2);map4.sync(map3);map4.sync(map);map4.sync(map5);map4.sync(map6);
		map5.sync(map2);map5.sync(map3);map5.sync(map4);map5.sync(map);map5.sync(map6);
		map6.sync(map2);map6.sync(map3);map6.sync(map4);map6.sync(map5);map6.sync(map);
		
		
		//button triggers
		$("#currentDate1").change(function(){
            var url = location.protocol + '//' + location.host + location.pathname;
            location.href = url + "?date="+moment($("#currentDate1").val()).format('YYYY-MM-DD')+"&width="+newW;
        });

        $( ".back" ).click(function() {
            var url = location.protocol + '//' + location.host + location.pathname;
            location.href = url + "?date="+yesterday.format('YYYY-MM-DD')+"&width="+newW;
        });
        $( ".forward" ).click(function() {
            var url = location.protocol + '//' + location.host + location.pathname;
            location.href = url + "?date="+tomorrow.format('YYYY-MM-DD')+"&dir=forward&width="+newW;

        });

        $( ".backYear" ).click(function() {
            var url = location.protocol + '//' + location.host + location.pathname;
            location.href = url + "?date="+moment($("#currentDate1").val()).add('years',-1).format('YYYY-MM-DD')+"&width="+newW;
        });
        $( ".forwardYear" ).click(function() {
            var url = location.protocol + '//' + location.host + location.pathname;
            location.href = url + "?date="+moment($("#currentDate1").val()).add('years',1).format('YYYY-MM-DD')+"&width="+newW;

        });
        $( "#larger" ).click(function() {
            var url = location.protocol + '//' + location.host + location.pathname;
            location.href = url + "?date="+currentDate.format('YYYY-MM-DD')+"&dir=forward&width="+Math.round(newW*1.1);

        });
        $( "#smaller" ).click(function() {
            var url = location.protocol + '//' + location.host + location.pathname;
            location.href = url + "?date="+currentDate.format('YYYY-MM-DD')+"&dir=forward&width="+Math.round(newW*0.9);

        });
		$('#cityToggle').on('change', function() {
			if ($("#cityToggle").is(':checked')) {
				map.addLayer(citiesLayer);
				map2.addLayer(citiesLayer2);
				map3.addLayer(citiesLayer3);
				map4.addLayer(citiesLayer4);
				map5.addLayer(citiesLayer5);
				map6.addLayer(citiesLayer6);
			}else{
				map.removeLayer(citiesLayer);
				map2.removeLayer(citiesLayer2);
				map3.removeLayer(citiesLayer3);
				map4.removeLayer(citiesLayer4);
				map5.removeLayer(citiesLayer5);
				map6.removeLayer(citiesLayer6);
			}
		});
	</script>
</html>
