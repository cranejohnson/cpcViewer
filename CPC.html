<!doctype html>
<html lang="en">
  <head>
    <link rel="stylesheet" href="http://openlayers.org/en/v3.4.0/css/ol.css" type="text/css">
    <style>
      .map {
        height: 300px;
        width: 400px;
        float:left;
        padding-left:5px;
        padding-right:5px;

      }
      .subtitle{
        font-size: 14px;
        height:20px;
        }

        #currentDate {
        text-align: center;
        height:20px;
        }

      .cpc {
          text-align: center;
          font-size: 24px;
          float:left;
          width:820px;
          font-family: sans-serif;
          background-color: gainsboro;
          margin-top:10px;

        }
     .msg{
         text-align: center;
         font-family: sans-serif;
         width:100%;
         height:20px;
         float:left;
         position: relative;
         top: 50%;
         transform: translateY(10%);
        }
     #main {
        width:820px;
     }
     .col {
        width:407px;
        float:left;
        border-style: solid;
        border-width: 1px;
     }
     .button {
        width:50%;
        float:left;

     }
     img {
        width:100%;
     }
     #legend {
      width:100%;
      font-size: 12px;
      font-weight: bold;
      text-align: center;
      }



    </style>
    <script src="http://openlayers.org/en/v3.4.0/build/ol.js" type="text/javascript"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src = "http://momentjs.com/downloads/moment.min.js"></script>
    <title>CPC Outlook</title>
  </head>
  <body>
    <div id="main">

        Current Date:<input type="text" name="firstname" id='currentDate1'><button  class = ' back'>-1 Day</button><button  class = ' forward'>+1 Day</button>
        <button  class = ' backYear'>-1 Year</button><button  class = ' forwardYear'>+1 Year</button><br>
        <button id='larger' type="button" >Larger</button>
        <button id='smaller' type="button" >Smaller</button></br>


        <table>
        <tr><td>
        <div class = 'cpc'>6-10 Day CPC Outlook<div id='title610' class='subtitle'></div></div>
        <div class = 'col'>
            <div id="message" class='msg'>Temperature</div>
            <div id="map" class="map"></div>
            <table id='legend'>
                <tr height="20"><td bgcolor="#150C32"></td><td bgcolor="#190F40"></td><td bgcolor="#222D5B"></td><td bgcolor="#094891"></td><td bgcolor="#2E8CD2"></td><td bgcolor="#66A5DB"></td><td bgcolor="#90B2D7"></td><td bgcolor="#FEFEFE"></td><td bgcolor="#E0A256"></td><td bgcolor="#E0A256"></td><td bgcolor="#CF4025"></td><td bgcolor="#B81A1F"></td><td bgcolor="#BE1A37"></td><td bgcolor="#75202B"></td><td bgcolor="#4E171E"></td></tr>
                <tr><td>90</td><td>80</td><td>70</td><td>60</td><td>50</td><td>40</td><td>33</td><td>Normal</td><td>33</td><td>40</td><td>50</td><td>60</td><td>70</td><td>80</td><td>90</td></tr>
                <tr><td colspan='7'>Prob. of Significantly Below (%)</td><td></td><td colspan='7'>Prob. of Significantly Above (%)</td></tr>
            </table>
        </div>
        <div class = 'col'>
            <div id="message2" class='msg'>Precipitation</div>
            <div id="map2" class="map"></div>
            <table id='legend'>
                <tr height="20"><td bgcolor="#3C2223"></td><td bgcolor="#6C3002"></td><td bgcolor="#7F322A"></td><td bgcolor="#873D25"></td><td bgcolor="#AA5826"></td><td bgcolor="#CE973E"></td><td bgcolor="#ECCC81"></td><td bgcolor="#FEFEFE"></td><td bgcolor="#A5D39B"></td><td bgcolor="#84C56B"></td><td bgcolor="#3CA22B"></td><td bgcolor="#2D6A4B"></td><td bgcolor="#117F31"></td><td bgcolor="#1F442E"></td><td bgcolor="#1F4512"></td></tr>
                <tr><td>90</td><td>80</td><td>70</td><td>60</td><td>50</td><td>40</td><td>33</td><td>Normal</td><td>33</td><td>40</td><td>50</td><td>60</td><td>70</td><td>80</td><td>90</td></tr>
                <tr><td colspan='7'>Prob. of Significantly Below (%)</td><td></td><td colspan='7'>Prob. of Significantly Above (%)</td></tr>
            </table>

        </div>
        <div class = 'cpc'>8-14 Day CPC Outlook<div id='title814' class='subtitle'></div></div>
        <div class = 'col'>
            <div id="message3" class='msg'>Temperature</div>
            <div id="map3" class="map"></div>
            <table id='legend'>
                <tr height="20"><td bgcolor="#150C32"></td><td bgcolor="#190F40"></td><td bgcolor="#222D5B"></td><td bgcolor="#094891"></td><td bgcolor="#2E8CD2"></td><td bgcolor="#66A5DB"></td><td bgcolor="#90B2D7"></td><td bgcolor="#FEFEFE"></td><td bgcolor="#E0A256"></td><td bgcolor="#E0A256"></td><td bgcolor="#CF4025"></td><td bgcolor="#B81A1F"></td><td bgcolor="#BE1A37"></td><td bgcolor="#75202B"></td><td bgcolor="#4E171E"></td></tr>
                <tr><td>90</td><td>80</td><td>70</td><td>60</td><td>50</td><td>40</td><td>33</td><td>Normal</td><td>33</td><td>40</td><td>50</td><td>60</td><td>70</td><td>80</td><td>90</td></tr>
                <tr><td colspan='7'>Prob. of Significantly Below (%)</td><td></td><td colspan='7'>Prob. of Significantly Above (%)</td></tr>
            </table>
        </div>
        <div class = 'col'>
            <div id="message4" class='msg'>Precipitation</div>
            <div id="map4" class="map"></div>
            <table id='legend'>
                <tr height="20"><td bgcolor="#3C2223"></td><td bgcolor="#6C3002"></td><td bgcolor="#7F322A"></td><td bgcolor="#873D25"></td><td bgcolor="#AA5826"></td><td bgcolor="#CE973E"></td><td bgcolor="#ECCC81"></td><td bgcolor="#FEFEFE"></td><td bgcolor="#A5D39B"></td><td bgcolor="#84C56B"></td><td bgcolor="#3CA22B"></td><td bgcolor="#2D6A4B"></td><td bgcolor="#117F31"></td><td bgcolor="#1F442E"></td><td bgcolor="#1F4512"></td></tr>
                <tr><td>90</td><td>80</td><td>70</td><td>60</td><td>50</td><td>40</td><td>33</td><td>Normal</td><td>33</td><td>40</td><td>50</td><td>60</td><td>70</td><td>80</td><td>90</td></tr>
                <tr><td colspan='7'>Prob. of Significantly Below (%)</td><td></td><td colspan='7'>Prob. of Significantly Above (%)</td></tr>
            </table>

        </div>
        </td><td>
        <div class = 'cpc'>Monthly CPC Outlook<div id='titleMonthly' class='subtitle'></div></div>
        <div class = 'col'>
            <div id="message5" class='msg'>Temperature</div>
            <div id="map5" class="map"></div>
            <table id='legend'>
                <tr height="20"><td bgcolor="#150C32"></td><td bgcolor="#190F40"></td><td bgcolor="#222D5B"></td><td bgcolor="#094891"></td><td bgcolor="#2E8CD2"></td><td bgcolor="#66A5DB"></td><td bgcolor="#90B2D7"></td><td bgcolor="#FEFEFE"></td><td bgcolor="#E0A256"></td><td bgcolor="#E0A256"></td><td bgcolor="#CF4025"></td><td bgcolor="#B81A1F"></td><td bgcolor="#BE1A37"></td><td bgcolor="#75202B"></td><td bgcolor="#4E171E"></td></tr>
                <tr><td>90</td><td>80</td><td>70</td><td>60</td><td>50</td><td>40</td><td>33</td><td>Normal</td><td>33</td><td>40</td><td>50</td><td>60</td><td>70</td><td>80</td><td>90</td></tr>
                <tr><td colspan='7'>Prob. of Significantly Below (%)</td><td></td><td colspan='7'>Prob. of Significantly Above (%)</td></tr>
            </table>
        </div>
        <div class = 'col'>
            <div id="message6" class='msg'>Precipitation</div>
            <div id="map6" class="map"></div>
            <table id='legend'>
                <tr height="20"><td bgcolor="#3C2223"></td><td bgcolor="#6C3002"></td><td bgcolor="#7F322A"></td><td bgcolor="#873D25"></td><td bgcolor="#AA5826"></td><td bgcolor="#CE973E"></td><td bgcolor="#ECCC81"></td><td bgcolor="#FEFEFE"></td><td bgcolor="#A5D39B"></td><td bgcolor="#84C56B"></td><td bgcolor="#3CA22B"></td><td bgcolor="#2D6A4B"></td><td bgcolor="#117F31"></td><td bgcolor="#1F442E"></td><td bgcolor="#1F4512"></td></tr>
                <tr><td>90</td><td>80</td><td>70</td><td>60</td><td>50</td><td>40</td><td>33</td><td>Normal</td><td>33</td><td>40</td><td>50</td><td>60</td><td>70</td><td>80</td><td>90</td></tr>
                <tr><td colspan='7'>Prob. of Significantly Below (%)</td><td></td><td colspan='7'>Prob. of Significantly Above (%)</td></tr>
            </table>

        </div>
        </td></tr></table>

    </div>
    <br>
    <br>
    <script type="text/javascript">

        function getURLParameter(name) {
            return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search)||[,""])[1].replace(/\+/g, '%20'))||null
        }

        //Function converts HTML color to decimal array i.e. FEFEFE becomes [254,254,254]
        var colorFunction = function(color){
             var colorArray = [parseInt(color.substring(0,2),16),parseInt(color.substring(2,4),16),parseInt(color.substring(4,6),16)];
             return colorArray;
        }



        var monthlyDate;
        var currentDate;
        var yesterday ;
        var tomorrow ;
        var searchDir = -1;   //Search backwards if data is missing
        if(getURLParameter('dir') == 'forward'){
            searchDir = 1;
        }

        var newW = 275;

        if(getURLParameter('width')){
            newW = parseInt(getURLParameter('width'));
        }
        $('.map').width(newW);
        $('#main').width(newW*2+30);
        $('.col').width(newW+12);
        $('.cpc').width(newW*2+30);
        $('.map').height(newW*0.75);

        if(getURLParameter('date')){
            $('#currentDate1').val(moment(getURLParameter('date')).format('YYYY-MM-DD'));
        }

        if(moment() < moment($('#currentDate1').val())){
            $('#currentDate1').val(moment().format('YYYY-MM-DD'));
        }

        if($('#currentDate1').val()){
            currentDate = moment($('#currentDate1').val()+" 12:00","YYYY-MM-DD");
            yesterday = moment($('#currentDate1').val()+" 12:00","YYYY-MM-DD").add(-1,'days');
            tomorrow = moment($('#currentDate1').val()+" 12:00","YYYY-MM-DD").add(1,'days');
            plotDate = getURLParameter('date').split("-").join("");
            monthlyDate = moment(getURLParameter('date')+" 12:00","YYYY-MM-DD");

        }
        else{
            currentDate = moment.utc();
            yesterday = moment.utc().add(-1,'days');
            tomorrow = moment.utc().add(1,'days');
            plotDate = moment.utc().format('YYYYMMDD');
            monthlyDate = moment.utc();

        }





        var found610 = false;
        var foundMonthly = false;
        var y = 0;
        var i = 0;

        while(i < 30){
            $.ajax({
                type: "GET",
                url: './cpcData/610temp_'+currentDate.format('YYYYMMDD')+'.kml',
                dataType: "xml",
                async: false,
                success: function(xml){
                    var temp = $(xml).find('name').first().text();
                    $("#title610").html(currentDate.format('YYYY-MM-DD'));
                    $("#title610").html(temp.match(/(Created.*)/)[0]);
                    found610 = true;
                },
                error: function(){
                        currentDate.add(searchDir,'days');
                        yesterday.add(searchDir,'days');
                        tomorrow.add(searchDir,'days');
                }
            });
            i = i+1;
            if(found610 == true) break;
        }


       $.ajax({
            type: "GET",
            url: './cpcData/814temp_'+currentDate.format('YYYYMMDD')+'.kml',
            dataType: "xml",
            async: false,
            success: function(xml){
                var temp = $(xml).find('name').first().text();
                $("#title814").html(currentDate.format('YYYY-MM-DD'));
                $("#title814").html(temp.match(/(Created.*)/)[0]);
            }
        });



        while(y < 30){
             $.ajax({
                type: "GET",
                url: './cpcData/monthly_temp_'+monthlyDate.format('YYYYMMDD')+'.kml',
                dataType: "xml",
                async: false,
                success: function(xml){
                    var temp = $(xml).find('name').first().text();
                    $("#titleMonthly").html(currentDate.format('YYYY-MM-DD'));
                    $("#titleMonthly").html(temp.match(/(Created.*)/)[0]);
                    foundMonthly = true;
                },
                error: function(){
                    monthlyDate.add(-1,'days');
                }
            });
            if(foundMonthly) break;
            y = y+1;
       }


        $("#currentDate1").val(currentDate.format('YYYY-MM-DD'));
        var styleFunction = function(feature, resolution) {

            var name = feature.get('name'); //
            var colors = ['3C2223','6C3002','7F322A','873D25','AA5826','CE973E','ECCC81','FEFEFE','FEFEFE','FEFEFE','FEFEFE','FEFEFE','FEFEFE','A5D39B','84C56B','3CA22B','2D6A4B','117F31','1F442E','1F4512'];

            var match = name.match(/Temp/);
            if(match){
            var colors = ['150C32','190F40','222D5B','094891','2E8CD2','66A5DB','90B2D7','FEFEFE','FEFEFE','FEFEFE','FEFEFE','FEFEFE','FEFEFE','E0A256','DA773A','CF4025','B81A1F','BE1A37','75202B','4E171E'];
            }
            var matchP = name.match(/[0-9]+/g);
            var Prob = Math.floor(parseInt(matchP[0])/10);

            var match = name.match(/Below/);
            if (match) {
            Prob = -Prob-1;
            }
            Prob = Prob+10;
            var opacity= 0.7;

            if(name.match(/EC/)){
                var plotColor = colorFunction('FEFEFE');

            }
            else{
               var plotColor = colorFunction(colors[Prob]);
            }

            plotColor.push(opacity);
            return [new ol.style.Style({
            fill: new ol.style.Fill({
              color:  plotColor
            }),
            stroke: new ol.style.Stroke({
              color: '#000000'
            })
            })];
        };

        // select interaction working on "pointermove"
        var selectPointerMove = new ol.interaction.Select({
            condition: ol.events.condition.pointerMove
        });

        // select interaction working on "pointermove"
        var selectPointerMove2 = new ol.interaction.Select({
            condition: ol.events.condition.pointerMove
        });
        // select interaction working on "pointermove"
        var selectPointerMove3 = new ol.interaction.Select({
            condition: ol.events.condition.pointerMove
        });

        // select interaction working on "pointermove"
        var selectPointerMove4 = new ol.interaction.Select({
            condition: ol.events.condition.pointerMove
        });

        // select interaction working on "pointermove"
        var selectPointerMove5 = new ol.interaction.Select({
            condition: ol.events.condition.pointerMove
        });

        // select interaction working on "pointermove"
        var selectPointerMove6 = new ol.interaction.Select({
            condition: ol.events.condition.pointerMove
        });

        //Add the vector CPC data to the map
        var temp610 = new ol.layer.Vector({
            source: new ol.source.KML({
                extractStyles: false,
                projection: 'EPSG:3857',
                url: './cpcData/610temp_'+currentDate.format('YYYYMMDD')+'.kml'
            }),
            style: styleFunction

        });

        var temp814 = new ol.layer.Vector({
            source: new ol.source.KML({
                extractStyles: false,
                projection: 'EPSG:3857',
                url: './cpcData/814temp_'+currentDate.format('YYYYMMDD')+'.kml'
            }),
            style: styleFunction

        });

        //Add the vector CPC data to the map
        var prcp610 = new ol.layer.Vector({
            source: new ol.source.KML({
                extractStyles: false,
                projection: 'EPSG:3857',
                url: './cpcData/610prcp_'+currentDate.format('YYYYMMDD')+'.kml'
            }),
            style: styleFunction

        });

        var prcp814 = new ol.layer.Vector({
            source: new ol.source.KML({
                extractStyles: false,
                projection: 'EPSG:3857',
                url: './cpcData/814prcp_'+currentDate.format('YYYYMMDD')+'.kml'
            }),
            style: styleFunction

        });

        var prcpMonthly = new ol.layer.Vector({
            source: new ol.source.KML({
                extractStyles: false,
                projection: 'EPSG:3857',
                url: './cpcData/monthly_prcp_'+monthlyDate.format('YYYYMMDD')+'.kml'
            }),
            style: styleFunction

        });

        var tempMonthly = new ol.layer.Vector({
            source: new ol.source.KML({
                extractStyles: false,
                projection: 'EPSG:3857',
                url: './cpcData/monthly_temp_'+monthlyDate.format('YYYYMMDD')+'.kml'
            }),
            style: styleFunction

        });
        //Add attribution for ESRI base map layer
        var attribution = new ol.Attribution({
          html: 'Tiles &copy; <a href="http://services.arcgisonline.com/ArcGIS/' +
              'rest/services/World_Topo_Map/MapServer">ArcGIS</a>'
        });

       //Setup base esri wms map layer
       var topo = new ol.layer.Tile({
            source: new ol.source.XYZ({
            attributions: [attribution],
            url: 'http://server.arcgisonline.com/ArcGIS/rest/services/' +
                'World_Topo_Map/MapServer/tile/{z}/{y}/{x}'
            })
        });



        $("#title").html("8-14 Day CPC Precip");


        var map = new ol.Map({
            target: 'map',
            layers: [topo,temp610],
            controls: [],
            view: new ol.View({
              center: ol.proj.transform([-152, 64], 'EPSG:4326', 'EPSG:3857'),
              zoom: 3
            })
        });


        var map2 = new ol.Map({
            target: 'map2',
            layers: [topo,prcp610],
            controls: [],
            view: new ol.View({
              center: ol.proj.transform([-152, 63], 'EPSG:4326', 'EPSG:3857'),
              zoom: 3
            })
        });

        var map3 = new ol.Map({
            target: 'map3',
            layers: [topo,temp814],
            controls: [],
            view: new ol.View({
              center: ol.proj.transform([-152, 63], 'EPSG:4326', 'EPSG:3857'),
              zoom: 3
            })
        });


        var map4 = new ol.Map({
            target: 'map4',
            layers: [topo,prcp814],
            controls: [],
            view: new ol.View({
              center: ol.proj.transform([-152, 63], 'EPSG:4326', 'EPSG:3857'),
              zoom: 3
            })
        });

        var map5 = new ol.Map({
            target: 'map5',
            layers: [topo,tempMonthly],
            controls: [],
            view: new ol.View({
              center: ol.proj.transform([-152, 63], 'EPSG:4326', 'EPSG:3857'),
              zoom: 3
            })
        });

        var map6 = new ol.Map({
            target: 'map6',
            layers: [topo,prcpMonthly],
            controls: [],
            view: new ol.View({
              center: ol.proj.transform([-152, 63], 'EPSG:4326', 'EPSG:3857'),
              zoom: 3
            })
        });

        map.on('pointermove', function(evt) {
          var feature = this.forEachFeatureAtPixel(this.getEventPixel(evt.originalEvent), function(feature, layer) {
            return feature;
          });
          if (feature) {
            $("#message").html(feature.get('name'));
          } else {
            $("#message").html("Temperature");
          }

        });

        map2.on('pointermove', function(evt) {
          var feature = this.forEachFeatureAtPixel(this.getEventPixel(evt.originalEvent), function(feature, layer) {
            return feature;
          });
          if (feature) {
            $("#message2").html(feature.get('name'));
          } else {
            $("#message2").html("Precipitation");
          }

        });

        map3.on('pointermove', function(evt) {
          var feature = this.forEachFeatureAtPixel(this.getEventPixel(evt.originalEvent), function(feature, layer) {
            return feature;
          });
          if (feature) {
            $("#message3").html(feature.get('name'));
          } else {
            $("#message3").html("Temperature");
          }

        });

        map4.on('pointermove', function(evt) {
          var feature = this.forEachFeatureAtPixel(this.getEventPixel(evt.originalEvent), function(feature, layer) {
            return feature;
          });
          if (feature) {
            $("#message4").html(feature.get('name'));
          } else {
            $("#message4").html("Precipitation");
          }

        });

        map5.on('pointermove', function(evt) {
          var feature = this.forEachFeatureAtPixel(this.getEventPixel(evt.originalEvent), function(feature, layer) {
            return feature;
          });
          if (feature) {
            $("#message5").html(feature.get('name'));
          } else {
            $("#message5").html("Temperature");
          }

        });

        map6.on('pointermove', function(evt) {
          var feature = this.forEachFeatureAtPixel(this.getEventPixel(evt.originalEvent), function(feature, layer) {
            return feature;
          });
          if (feature) {
            $("#message6").html(feature.get('name'));
          } else {
            $("#message6").html("Precipitation");
          }

        });

        map2.bindTo('view', map);
        map3.bindTo('view', map);
        map4.bindTo('view', map);
        map5.bindTo('view', map);
        map6.bindTo('view', map);
        map.addInteraction(selectPointerMove);
        map2.addInteraction(selectPointerMove2);
        map3.addInteraction(selectPointerMove3);
        map4.addInteraction(selectPointerMove4);
        map5.addInteraction(selectPointerMove5);
        map6.addInteraction(selectPointerMove6);


        $("#currentDate1").change(function(){
            var url = location.protocol + '//' + location.host + location.pathname;
            location.href = url + "?date="+moment($("#currentDate1").val()).format('YYYY-MM-DD')+"&width="+newW;
        });

        $( ".back" ).click(function() {
            var url = location.protocol + '//' + location.host + location.pathname;
            location.href = url + "?date="+yesterday.format('YYYY-MM-DD')+"&width="+newW;
        });
        $( ".forward" ).click(function() {
            var url = location.protocol + '//' + location.host + location.pathname;
            location.href = url + "?date="+tomorrow.format('YYYY-MM-DD')+"&dir=forward&width="+newW;

        });

        $( ".backYear" ).click(function() {
            var url = location.protocol + '//' + location.host + location.pathname;
            location.href = url + "?date="+moment($("#currentDate1").val()).add('years',-1).format('YYYY-MM-DD')+"&width="+newW;
        });
        $( ".forwardYear" ).click(function() {
            var url = location.protocol + '//' + location.host + location.pathname;
            location.href = url + "?date="+moment($("#currentDate1").val()).add('years',1).format('YYYY-MM-DD')+"&width="+newW;

        });
        $( "#larger" ).click(function() {
            var url = location.protocol + '//' + location.host + location.pathname;
            location.href = url + "?date="+currentDate.format('YYYY-MM-DD')+"&dir=forward&width="+Math.round(newW*1.1);

        });
        $( "#smaller" ).click(function() {
            var url = location.protocol + '//' + location.host + location.pathname;
            location.href = url + "?date="+currentDate.format('YYYY-MM-DD')+"&dir=forward&width="+Math.round(newW*0.9);

        });




     </script>
  </body>
</html>
